## 10. 어노테이션과 리플렉션
> 미리 알지 못하는 임의의 클래스를 다루는 어노테이션과 리플렉션에 대해 알아보자.

- 어노테이션 : 라이브러리가 요구하는 의미를 클래스에게 부여
- 리플렉션 : 실행 시점에 컴파일러 내부 구조를 분석

### 10.1 어노테이션 선언과 적용
메타데이터를 선언에 추가하면 컴파일 시점이나 실행 시점에 적절한 처리가 가능하다.

#### 10.1.1 어노테이션 적용
- 적용하고자 하는 대상 앞에 사용
- @ + 어노테이션 이름으로 구성
- 함수, 클래스 등 여러 구성 요소에 사용 가능

**기본 문법 예시**
```kotlin
import org.junit.*

class MyTest {
  @Test fun testTrue() {
    Assert.assertTrue(true)
  }
}
```
코틀린에서는 `replaceWith` 파라미터를 이용해 이전 버전을 대신할 수 있는 패턴 제시를 할 수 있다.

```kotlin
// () 안에 인자를 전달
@Deprecated("Use removeAt (index) instead.", ReplaceWith("removeAt (index)"))
fun remove(index: Int) {...}
```

어노테이션의 인자로 원시 타입의 값, 문자열, enum, 클래스 참조, 다른 어노테이션 등 사용할 수 있으며 문법은 다음과 같다.

- 클래스 : `@MyAnnotation(Myclass::Class)`와 같이 `::class`를 이름 뒤에 사용
- 다른 어노테이션 : 인자로 들어가는 어노테이션 앞에 @를 제거
- 배열 : `arrayOf()`를 사용
  - 자바에서 선언한 어노테이션 클래스를 사용할 경우 value가 자동으로 가변 길이 인자로 변환
  - `@JavaAnnotationWithArrayValue("abc", "foo")`와 같이 `arrayOf()`를 사용하지 않아도 됨

**kotlin**
```kotlin
// 어노테이션 정의
annotation class MyAnnotation(val values: Array<String>)

@MyAnnotation(arrayOf("abc", "def")) // arrayOf()를 사용해야 함
fun myFunction() { }

// 코틀린에서 자바 어노테이션 사용 시
@JavaAnnotation("abc", "def") // arrayOf() 생략 가능
fun myFunction() { }
```

**java**
```java
// 어노테이션 정의
@interface MyAnnotation {
    // value를 가변인자로 인식
    String[] value();
}
// 배열 명시적의로 전달
@MyAnnotation({"abc", "def"}) // 배열을 명시적으로 전달
public void myFunction() { }

// 배열 암묵적으로 전달
@MyAnnotation("abc", "def") // 배열을 암묵적으로 전달
public void myFunction() { }
```

- 어노테이션 인자를 컴파일 시점에 알아야하기 때문에 임의의 프로퍼티를 인자로 지정 불가능
- `const` 변경자를 사용하여 프로퍼티를 어노테이션 인자로 사용
- 컴파일러는 `const`가 붙은 프로퍼티를 컴파일 시점 상수로 취급

```kotlin
// 상수로 취급
const val TEST_TIMEOUT = 100L
@Test(timeout = TEST_TIMEOUT) fun testMethod() {...}
```
- `const`는 파일의 맨 위 또는 ojbect 안에 선언
- 원시 타입 또는 String으로 초기화

#### 10.1.2 어노테이션 대상
코틀린과 자바 선언에 여러 대응이 발생하는 경우 명시적으로 어노테이션을 표시해야하는 경우가 있다.

- 코틀린 프로퍼티 : 자바 필드와 게터 선언과 대응
- 프로퍼티 변경 가능 : 세터와 대응
- 주 생성자 : 자바 생성자 파라미터와 대응

이런 경우 **사용 지점 대상** 선언으로 어노테이션을 붙일 요소를 지정한다.

- @ 기호와 어노테이션 이름 사이에 사용 지점 대상을 기입
- 콜론(:)으로 분리
- ex : `@get:Rule`

```kotlin
class HasTempFolder {
    // getter에 어노테이션 사용
    @get:Rule
    val folder = TemporaryFolder()
    
    @Test
    fun testUsingTempFolder() {...}
}
```

- 공개 필드나 메서드 앞에 어노테이션 사용
- 프로퍼티 앞에 어노테이션 사용 시 예외 발생
- 자바로 선언한 어노테이션의 경우 프로퍼티의 필드에 그 어노테이션이 붙음
- 코틀린은 프로퍼티에 직접 적용할 수 있는 어노테이션을 만들어야함

**사용 지점 대상 목록**
- `property` : 프로퍼티 전체, 자바에서 선언된 어노테이션에는 사용 불가
- `field` : 프로퍼티에 의해 생성되는 백킹 필드
- `get` : 게터
- `set` : 세터
- `receiver` : 확장 함수 및 프로퍼티의 수신 객체 파라미터
- `param` : 생성자 파라미터
- `setparam` : 세터 파라미터
- `delegate` : 위엄 프로퍼티의 위임 인스턴스를 담아둔 필드
- `file` : 파일 안에 선언된 최상위 함수 및 프로퍼티를 담은 클래스
  - package 선언 앞에서 파일의 최상위 수준에만 적용 가능

```kotlin
// property
// 자바와의 상호 운용성에 적합하지 않음
@property:Annotation
var myProperty: String = "Hello"

// field
// 컴파일된 자바 클래스에서 필드 레벨에 적용
@field:Annotation
var myField: String = "Hello"

// get & set
@get:Annotation
val myProperty: String = "Hello"
@set:Annotation
var myProperty: String = "Hello"

// receiver
// 수신 객체(String)에 적용
fun @receiver:Annotation String.customFunction() {
    println(this)
}

// param
// 자바로 변환 시 생성자 파라미터의 메타데이터에 포함
class MyClass(@param:Annotation val name: String)

// setparam
@setparam:Annotation
var myProperty: String = "Hello"

// delegate
// 인스턴스를 담는 백킹 필드에 적용
class MyDelegate {
    operator fun getValue(thisRef: Any?, property: KProperty<*>): String = "Hello"
    operator fun setValue(thisRef: Any?, property: KProperty<*>, value: String) {}
}

class MyClass {
    @delegate:Annotation
    val myProperty: String by MyDelegate()
}

// file
@file:Annotation
package my.package

fun topLevelFunction() {}
```

- 어노테이션 인자로 클래스 또는 함수 선언 외 임의 식을 허용

```kotlin
fun test(list: List<*>) {
  @Suppress("UNCHECKED_CAST")
  val strings = list as List<String>
  // ...
}
```

`@Volatile`, `@Strictfp` 어노테이션은 자바의 `volatile`과 `strictfp` 키워들 대신한다. 
다음 나열한 어노테이션 사용 시 코틀린 선언을 자바에 노출시키는 방법 변경이 가능하다.

- `@JvmName` : 코틀린 선언이 만든 자바 필드나 메서드 이름 변경
- `@JvmStatic` : 메서드, 객체 선언, 동반 객체에 적용 시 자바 정적 메서드로 노출
- `@JvmOverloads` : 컴파일러가 자동으로 디폴트 파라미터 값이 있는 함수를 오버로딩
- `@JvmField` : 프로퍼티에 사용 시 public 자바 필드로 프로퍼티 노출

#### 10.1.3 어노티에션을 활용한 JSON 직렬화 제어
  
