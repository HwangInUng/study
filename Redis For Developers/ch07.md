# 레디스 데이터 백업 방법
## 개요
레디스는 인메모리 데이터베이스로 데이터가 메모리에 저장되기 때문에, 서버 장애나 재시작 시 데이터 손실을 방지하기 위해 영구 저장(Persistence) 기능이 필요합니다.

## 데이터 영구 저장 방식
RDB (Redis Database) 백업
> 관계형 데이터베이스와 유사한 방식으로 특정 시점의 데이터 스냅샷을 파일로 저장

### 특징
- 바이너리 형태의 압축된 파일
- 빠른 백업 및 복원 속도
- 주기적인 스냅샷 생성

### RDB 파일 생성 방법
```bash
save <기간(초)> <기간 내 변경된 키의 개수>
dbfilename <RDB 파일 이름>
dir <RDB 파일이 저장될 경로>
```
`redis.conf`에 위와 같은 조건으로 save 옵션을 설정

- 자동 생성: 특정 조건 만족 시 자동으로 RDB 파일 생성
- 수동 생성: `SAVE` 또는 `BGSAVE` 명령어로 수동 생성
- 복제 시 자동 생성: 복제를 사용할 경우 자동으로 RDB 파일 생성

## AOF (Append Only File) 백업
> 모든 쓰기 작업을 로그 파일에 순차적으로 기록하는 방식

### 특징
- 더 높은 데이터 안정성 제공
- 실시간으로 변경사항 기록
- 복원 시 모든 명령어를 순차적으로 재실행

### AOF 주요 기능
- AOF Rewrite: 파일 크기 최적화를 위한 압축 기능
- 자동 AOF Rewrite: 특정 조건에서 자동으로 압축 수행
- 수동 AOF Rewrite: BGREWRITEAOF 명령어로 수동 압축
- AOF Timestamp: 시간 정보 기록 기능
- AOF 파일 복원: 시스템 재시작 시 AOF 파일을 통한 데이터 복원

**AOF Rewrite**
AOF(Append Only File) Rewrite는 Redis의 성능 최적화와 저장 공간 효율성을 위한 핵심 기능입니다. 시간이 지나면서 AOF 파일 크기가 증가하여 성능 저하와 디스크 공간 문제를 일으킬 수 있어, 이를 해결하기 위해 AOF Rewrite 기능을 제공한다.

문제점
- 동일한 키에 대한 중복 명령어들이 계속 축적
- 파일 크기 증가로 인한 복구 시간 지연
- 디스크 공간 낭비

해결책
AOF Rewrite는 완전히 안전한 작업으로 Redis가 기존 파일에 계속 추가하는 동안, 현재 데이터 세트를 생성하는 데 필요한 최소한의 작업 세트로 완전히 새로운 파일이 생성된다.

예시
```bash
// Rewrite 전
SET stock 100
INCR stock
INCR stock
INCR stock
DEL temp_key
SET temp_key value
DEL temp_key

// Rewrite 후
SET stock 103
```

버전 7 이후 재구성
- `fork`를 이용해 자식 프로세스 생성
- 레디스 메모리의 데이터를 읽어와 신규로 생성한 임시 파일에 저장
- 백그라운드로 위 과정이 진행되는 동안 레디스 메모리의 데이터가 변경된 내역을 신규 파일에 저장
- 재구성 과정이 끝나면 임시 매니페스트 파일을 생성
- 변경된 버전으로 매니페스트 파일 내용 업데이트
- 생성된 임시 매니페스트 파일로 기존 매니페스트 파일을 덮어씀
- 이전 버전의 AOF, RDB 파일 삭제

## 백업 사용 시 주의사항**
- RDB와 AOF 모두 사용하는 경우 복원 시 AOF 파일을 우선적으로 사용
- 백업 파일의 크기와 성능 간의 트레이드오프 고려
- 복제 환경에서의 백업 설정 최적화 필요 (maxmemory)
