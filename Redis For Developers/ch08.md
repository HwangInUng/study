# 복제 (Replication)

## 개요
> 레디스의 고가용성(High Availability)을 확보하기 위한 핵심 기능으로, 마스터 노드의 데이터를 복제본 노드로 실시간 복사하는 기능입니다.
고가용성을 위한 두 가지 필수 기능

## 복제 (Replication)
- 마스터 노드의 데이터를 복제본 노드로 실시간 복사
- 마스터 노드 장애 시 복제본 노드에서 데이터 확인 가능

## 자동 페일오버 (Auto Failover)
- 마스터 노드 장애 발생 시 자동으로 클라이언트 연결을 복제본 노드로 리디렉션
- 수동 엔드포인트 변경 없이 빠른 장애 조치 가능

## 복제 구조 특징
### 기본 구조
- Master-Replica 형태: 하나의 마스터 노드와 다수의 복제본 노드
- 읽기 전용 복제본: 복제본 노드는 기본적으로 읽기 전용으로 동작
- 단일 마스터: 한 복제 그룹에는 항상 하나의 마스터 노드만 존재

> MySQL or PostgreSQL은 멀티 마스터 복제 구조로 모든 노드가 마스터이면서 동시에 복제본이 되는 구조이며,
> 레디스는 멀티 마스터 구조를 지원하지 않음.

### 복제 설정 방법
```bash
# 복제본 노드에서 실행
REPLICAOF <master-ip> <master-port>
```

### 패스워드 설정
마스터와 복제본 노드는 동일한 패스워드로 설정 권장

```bash
# 마스터 노드
CONFIG SET requirepass mypassword
CONFIG REWRITE

# 복제본 노드
CONFIG SET masterauth mypassword
CONFIG REWRITE
```

### 복제 메커니즘
**비동기 복제**
- 복제본에 데이터 전달 확인 과정 생략
- 짧은 지연시간과 높은 성능 제공

**복제 ID와 오프셋**
- 복제 ID: 동일한 데이터셋을 갖는다는 의미
- 오프셋: 복제본이 마스터의 어디까지 복제되었는지 확인
- ID + 오프셋이 같으면 두 노드는 정확히 일치된 상태

**부분 재동기화 (Partial Resynchronization)**
- 네트워크 장애 후 복제 연결 복구 시 사용
- 마스터의 백로그 버퍼를 활용하여 필요한 부분만 동기화
- 전체 재동기화보다 빠르고 효율적

**Secondary 복제 ID**
- 레디스는 2개의 복제 ID를 보유
- 마스터로 승격되는 복제본을 위한 기능
- 페일오버 후 새로운 마스터에 연결 시 전체 재동기화 방지

**복제 설정 옵션**
repl-diskless-sync
- 기본값: yes (Redis 7.0 이후)
- 디스크를 거치지 않고 소켓으로 직접 RDB 전송

repl-diskless-sync-delay
- 기본값: 5초
- 여러 복제본의 동시 연결을 위한 대기 시간

replica-read-only
- 복제본의 읽기 전용 모드 제어
- 기본값은 yes (읽기 전용)

replica-serve-stale-data
- 기본값: yes
- 복제본 데이터가 유효하지 않을 때도 읽기 요청에 응답

### 복제 상태 확인
```
bash
INFO REPLICATION
```
복제 연결 상태, 오프셋, 지연 시간 등을 확인할 수 있습니다.

## 주의사항
### 백업 없는 복제 사용 시 위험성
- 마스터 노드 장애로 메모리 초기화
- 복제본에는 데이터가 있지만 마스터로 복제 연결 시도
- 마스터에서 빈 데이터셋을 복제본으로 전달하여 데이터 손실

### 권장사항
- 복제 기능 사용 시 백업 기능도 함께 사용
- 백업 미사용 시 마스터의 자동 재시작 비활성화

### 복제본 데이터 변경 시 주의사항
- 복제본에서 직접 데이터 변경 시 로컬에서만 유지
- 전체 재동기화 시 복제본의 변경사항은 사라짐
- 다른 복제본으로는 전파되지 않음
